<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰‹æ›¸ããƒ¡ãƒ¢</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
        }
        #controls {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        #memoCanvas {
            border: 2px solid #333;
            background-color: white; /* æ¶ˆã—ã‚´ãƒ æ©Ÿèƒ½ã®ãŸã‚ã®èƒŒæ™¯è‰² */
            cursor: crosshair;
        }
        button {
            padding: 4px 10px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            background-color: #007bff;
            color: white;
            transition: background-color 0.3s;
        }
        button:hover:not(:disabled) {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #007bff;
            cursor: not-allowed;
        }
        .active-tool {
            background-color: #28a745; /* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ„ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã®è‰² */
        }
        .active-tool:hover {
            background-color: #1e7e34;
        }
        label {
            font-weight: bold;
            color: #333;
        }
    </style>
</head>
<body>

    
    <div id="controls">
  
        <input type="color" id="colorPicker" value="#000000">
        
     
        <input type="range" id="thicknessSlider" min="1" max="10" value="3">
        
        <button id="penButton" class="active-tool">ãƒšãƒ³</button>
        <button id="eraserButton">ğŸ§¹</button> 
        
        <button id="undoButton" disabled>æˆ»ã‚‹</button>
        
        <button id="clearButton">å‰Šé™¤</button>
    </div>

    <canvas id="memoCanvas" width="800" height="500"></canvas>

    <script>
        // --- å¤‰æ•°ã®å®šç¾© ---
        const canvas = document.getElementById('memoCanvas');
        const ctx = canvas.getContext('2d');
        const clearButton = document.getElementById('clearButton');
        const undoButton = document.getElementById('undoButton');
        const colorPicker = document.getElementById('colorPicker');
        const thicknessSlider = document.getElementById('thicknessSlider');
        const penButton = document.getElementById('penButton');
        const eraserButton = document.getElementById('eraserButton');
        
        // localStorageã®ã‚­ãƒ¼
        const storageKey = 'handwrittenMemoData';
        const historyKey = 'drawingHistory';
        
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;

        let drawingHistory = []; // æç”»å±¥æ­´ã‚’ä¿å­˜ã™ã‚‹ã‚¹ã‚¿ãƒƒã‚¯ï¼ˆData URLã®é…åˆ—ï¼‰
        const MAX_HISTORY = 10;  // ä¿æŒã™ã‚‹å±¥æ­´ã®æœ€å¤§æ•°

        let currentTool = 'pen'; // 'pen'ã¾ãŸã¯'eraser'
        
        // --- åˆ¶å¾¡é–¢æ•° ---
        
        // Undoãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
        function updateUndoButtonState() {
            // å±¥æ­´ãŒ1ã¤ä»¥ä¸Šã‚ã‚‹å ´åˆï¼ˆã‚¯ãƒªã‚¢ãªçŠ¶æ…‹ã‚’é™¤ãï¼‰ã«ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹ã«ã™ã‚‹
            undoButton.disabled = drawingHistory.length <= 0;
        }

        // æ‰‹æ›¸ãã®çŠ¶æ…‹ã¨å±¥æ­´ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
        function saveMemo() {
            // 1. ã‚­ãƒ£ãƒ³ãƒã‚¹ã®å†…å®¹ã‚’Data URLã¨ã—ã¦å–å¾—
            const dataURL = canvas.toDataURL();

            // 2. å±¥æ­´ã‚¹ã‚¿ãƒƒã‚¯ã‚’æ›´æ–°
            // æ–°ã—ã„çŠ¶æ…‹ã‚’ã‚¹ã‚¿ãƒƒã‚¯ã«è¿½åŠ ï¼ˆæœ€å¤§æ•°ã‚’è¶…ãˆãŸã‚‰å¤ã„ã‚‚ã®ã‹ã‚‰å‰Šé™¤ï¼‰
            drawingHistory.push(dataURL);
            if (drawingHistory.length > MAX_HISTORY) {
                drawingHistory.shift(); 
            }
            
            // 3. ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«æœ€æ–°ã®ã‚­ãƒ£ãƒ³ãƒã‚¹çŠ¶æ…‹ã¨å±¥æ­´ã‚’ä¿å­˜
            localStorage.setItem(storageKey, dataURL);
            localStorage.setItem(historyKey, JSON.stringify(drawingHistory));

            updateUndoButtonState(); // Undoãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
        }

        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ä¿å­˜ã•ã‚ŒãŸç”»åƒãƒ‡ãƒ¼ã‚¿ã¨å±¥æ­´ã‚’ãƒ­ãƒ¼ãƒ‰
        function loadMemo() {
            // 1. å±¥æ­´ã‚¹ã‚¿ãƒƒã‚¯ã®ãƒ­ãƒ¼ãƒ‰
            const historyJSON = localStorage.getItem(historyKey);
            if (historyJSON) {
                drawingHistory = JSON.parse(historyJSON);
            }
            
            // 2. æœ€æ–°ã®ã‚­ãƒ£ãƒ³ãƒã‚¹çŠ¶æ…‹ã®ãƒ­ãƒ¼ãƒ‰
            const dataURL = localStorage.getItem(storageKey);
            if (dataURL) {
                const img = new Image();
                img.onload = function() {
                    // ãƒ­ãƒ¼ãƒ‰ã—ãŸç”»åƒã‚’ã‚­ãƒ£ãƒ³ãƒã‚¹ã«æç”»
                    ctx.drawImage(img, 0, 0);
                };
                img.src = dataURL;
            }
            
            updateUndoButtonState(); // Undoãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
        }
        
        // ä¸€ã¤å‰ã®æç”»çŠ¶æ…‹ã«æˆ»ã™
        function undoDrawing() {
            if (drawingHistory.length > 0) {
                // 1. ç¾åœ¨ã®æœ€æ–°ã®çŠ¶æ…‹ã‚’ã‚¹ã‚¿ãƒƒã‚¯ã‹ã‚‰å‰Šé™¤
                drawingHistory.pop();
                
                // 2. å¾©å…ƒã™ã‚‹Data URLã‚’å–å¾—
                const previousDataURL = drawingHistory.length > 0 
                                      ? drawingHistory[drawingHistory.length - 1]
                                      : null;

                // 3. ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ã‚¯ãƒªã‚¢ã—ã€å‰ã®çŠ¶æ…‹ã‚’æç”»
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                if (previousDataURL) {
                    const img = new Image();
                    img.onload = function() {
                        ctx.drawImage(img, 0, 0);
                        
                        // 4. ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®æœ€æ–°çŠ¶æ…‹ã‚‚æ›´æ–°
                        localStorage.setItem(storageKey, previousDataURL);
                        localStorage.setItem(historyKey, JSON.stringify(drawingHistory));
                        updateUndoButtonState();
                    };
                    img.src = previousDataURL;
                } else {
                    // å±¥æ­´ãŒç©ºã«ãªã£ãŸå ´åˆã€ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚‚å‰Šé™¤
                    localStorage.removeItem(storageKey);
                    localStorage.removeItem(historyKey);
                    updateUndoButtonState();
                }
            }
        }

        // æç”»è¨­å®šã‚’æ›´æ–°ï¼ˆãƒ„ãƒ¼ãƒ«åˆ‡ã‚Šæ›¿ãˆæ™‚ã‚„è¨­å®šå¤‰æ›´æ™‚ï¼‰
        function setupContext() {
            ctx.lineJoin = 'round';
            ctx.lineCap = 'round';
            ctx.lineWidth = thicknessSlider.value;
            
            if (currentTool === 'eraser') {
                // æ¶ˆã—ã‚´ãƒ ãƒ¢ãƒ¼ãƒ‰ï¼šæç”»è‰²ã‚’èƒŒæ™¯è‰²ï¼ˆç™½ï¼‰ã«ã™ã‚‹
                ctx.strokeStyle = '#FFFFFF';
            } else {
                // ãƒšãƒ³ãƒ¢ãƒ¼ãƒ‰ï¼šã‚«ãƒ©ãƒ¼ãƒ”ãƒƒã‚«ãƒ¼ã§é¸æŠã•ã‚ŒãŸè‰²ã«ã™ã‚‹
                ctx.strokeStyle = colorPicker.value;
            }
        }
        
        // ãƒ„ãƒ¼ãƒ«ï¼ˆãƒšãƒ³/æ¶ˆã—ã‚´ãƒ ï¼‰ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
        function activateTool(tool) {
            currentTool = tool;
            setupContext(); // æç”»è¨­å®šã‚’æ›´æ–°

            // ãƒœã‚¿ãƒ³ã®è¦‹ãŸç›®ã‚’æ›´æ–°
            if (tool === 'pen') {
                penButton.classList.add('active-tool');
                eraserButton.classList.remove('active-tool');
                canvas.style.cursor = 'crosshair';
            } else {
                eraserButton.classList.add('active-tool');
                penButton.classList.remove('active-tool');
                // æ¶ˆã—ã‚´ãƒ ç”¨ã®ã‚«ãƒ¼ã‚½ãƒ«ã‚’è¨­å®šï¼ˆã“ã“ã§ã¯æ¨™æº–ã®ã‚«ãƒ¼ã‚½ãƒ«ã‚’ä½¿ç”¨ï¼‰
                canvas.style.cursor = 'cell'; 
            }
        }

        // ãƒã‚¦ã‚¹/ã‚¿ãƒƒãƒåº§æ¨™ã®å–å¾—
        function getCoordinates(e) {
            const rect = canvas.getBoundingClientRect();
            let x, y;

            if (e.touches && e.touches.length > 0) {
                // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆ
                x = e.touches[0].clientX - rect.left;
                y = e.touches[0].clientY - rect.top;
            } else {
                // ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆ
                x = e.clientX - rect.left;
                y = e.clientY - rect.top;
            }
            return [x, y];
        }

        // --- æç”»å‡¦ç† ---

        // æç”»é–‹å§‹
        function startDrawing(e) {
            isDrawing = true;
            setupContext(); // ç¾åœ¨ã®ãƒ„ãƒ¼ãƒ«è¨­å®šã‚’é©ç”¨
            [lastX, lastY] = getCoordinates(e); 
        }

        // æç”»å®Ÿè¡Œ
        function draw(e) {
            if (!isDrawing) return;
            e.preventDefault();
            
            const [currentX, currentY] = getCoordinates(e);

            // ç·šã®æç”»
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(currentX, currentY);
            ctx.stroke();

            lastX = currentX;
            lastY = currentY;
        }

        // æç”»çµ‚äº†
        function stopDrawing() {
            if (isDrawing) {
                isDrawing = false;
                // æç”»ãŒå®Œäº†ã—ãŸã‚‰å†…å®¹ã‚’å±¥æ­´ã«ä¿å­˜
                saveMemo(); 
            }
        }

        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---

        // ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆ
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);

        // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆ (ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ)
        canvas.addEventListener('touchstart', startDrawing);
        canvas.addEventListener('touchmove', draw);
        canvas.addEventListener('touchend', stopDrawing);
        canvas.addEventListener('touchcancel', stopDrawing);

        // ãƒ„ãƒ¼ãƒ«ãƒœã‚¿ãƒ³
        penButton.addEventListener('click', () => activateTool('pen'));
        eraserButton.addEventListener('click', () => activateTool('eraser'));

        // Undoãƒœã‚¿ãƒ³
        undoButton.addEventListener('click', undoDrawing);

        // æ¶ˆå»ãƒœã‚¿ãƒ³
        clearButton.addEventListener('click', () => {
            if (confirm('ãƒ¡ãƒ¢ã®å†…å®¹ã‚’å…¨ã¦æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ')) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                localStorage.removeItem(storageKey);
                localStorage.removeItem(historyKey);
                drawingHistory = []; // å±¥æ­´ã‚¹ã‚¿ãƒƒã‚¯ã‚’ãƒªã‚»ãƒƒãƒˆ
                updateUndoButtonState();
            }
        });

        // è‰²ã‚„å¤ªã•ã®å¤‰æ›´æ™‚
        colorPicker.addEventListener('input', () => activateTool('pen')); // è‰²ã‚’å¤‰ãˆãŸã‚‰ãƒšãƒ³ãƒ„ãƒ¼ãƒ«ã«åˆ‡ã‚Šæ›¿ãˆã‚‹
        thicknessSlider.addEventListener('input', setupContext);

        // --- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹• ---
        
        setupContext(); // åˆæœŸè¨­å®šã‚’é©ç”¨
        loadMemo();     // éå»ã®ãƒ¡ãƒ¢ã¨å±¥æ­´ã‚’ãƒ­ãƒ¼ãƒ‰
    </script>
</body>
</html>
